# Copyright Vespa.ai. All rights reserved.

schema product {

  document product {

    field language type string {
      indexing: "en" | set_language
    }

    field id type int {
      indexing: attribute | summary
    }

    field title type string {
      indexing: index | summary
      index: enable-bm25
    }

    field description type string {
      indexing: index | summary
      index: enable-bm25
    }

    field category type string {
      indexing: attribute | summary
      attribute: fast-search
      match: word
      rank: filter
    }

    field price type int {
      indexing: attribute | summary
    }

    field quantity type int {
      indexing: attribute | summary
    }

    field average_rating type float {
      indexing: attribute | summary
    }
  }
  field embedding type tensor<float>(x[384]) {
        indexing: input title . " " . input description | embed | index | attribute
        attribute {
            distance-metric: angular
        }
        index {
            hnsw {
                max-links-per-node: 16
                neighbors-to-explore-at-insert: 200
            }
        }
  }

  fieldset default {
    fields: title, description
  }

  rank-profile bm25 {
   
    function raw_bm25() {
      expression: (0.6 * bm25(title)) + (0.4 * bm25(description))
    }
      function scaled_bm25() {
        # Squashes the raw BM25 sum into (0, 1).
        # Adjust the denominator constant if you want a different curve.
        expression: raw_bm25 / (raw_bm25 + 11)
      }
      
    first-phase {
      expression: scaled_bm25
    }
  }

  rank-profile closeness {
    inputs {
      query(q_embedding) tensor<float>(x[384])
    }
    first-phase {
      expression: closeness(field, embedding)
    }
  }

  rank-profile hybrid inherits bm25, closeness {
      function weighted_hybrid()
      {
        expression: 0.2 * scaled_bm25 + 0.8 * closeness_embedding
      }
      function closeness_embedding(){
        expression: closeness(field, embedding)
      }
    first-phase {
     
      expression: weighted_hybrid()
    }
  match-features {
    scaled_bm25()
    closeness_embedding()
    weighted_hybrid()
    }
  }

  document-summary minimal {
    summary id {}
  }

  document-summary medium {
    summary id {}
    summary title {}
    summary description {}
  }

}
